<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Update User Password</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="static/css/main.css">
    <link rel="stylesheet" href="static/css/font-awesome.min.css">
  </head>
  <body class="app sidebar-mini rtl">
    <header class="app-header"><a class="app-header__logo" href="index.html">GHA School Shop</a></header>
    <main class="app-content">
      <div class="app-title">
        <div>
          <h1><i class="fa fa-key"></i> Update Password</h1>
          <p>Change a staff user's password</p>
        </div>
        <p><a href="page-user-list.html">Back to Staff List <i class="fa fa-arrow-left fa-lg"></i></a></p>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="tile">
            <h3 class="tile-title">Update Password</h3>
            <div class="tile-body">
              <form id="updatePasswordForm" method="POST">
                <input type="hidden" id="user_id" name="user_id" value="">
                <div class="form-group">
                  <label>Staff Name</label>
                  <input class="form-control" id="staff_name" readonly>
                </div>
                <div class="form-group">
                  <label>New Password</label>
                  <input class="form-control" id="new_password" type="password" autocomplete="new-password">
                </div>
                <div class="form-group">
                  <label>Confirm Password</label>
                  <input class="form-control" id="confirm_password" type="password" autocomplete="new-password">
                </div>
                <div class="tile-footer">
                  <button class="btn btn-primary" type="submit"><i class="fa fa-check-circle"></i> Update Password</button>
                  <a class="btn btn-secondary" href="page-user-list.html">Cancel</a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

    </main>

    <script src="static/js/jquery-3.2.1.min.js"></script>
    <script src="static/js/plugins/bootstrap-notify.min.js"></script>
    <script>
      function getParameterByName(name) {
        name = name.replace(/[\[\]]/g, "\\$&");
        var url = window.location.href;
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }

      $(function(){
        var uid = getParameterByName('user_id');
        var name = getParameterByName('name') || '';
        if (uid) {
          $('#user_id').val(uid);
          $('#staff_name').val(decodeURIComponent(name));
        }

        $('#updatePasswordForm').on('submit', function(e){
          e.preventDefault();
          var user_id = $('#user_id').val() || null;
          var new_password = $('#new_password').val();
          var confirm_password = $('#confirm_password').val();

          if (!new_password) {
            $.notify({ title: "Missing: ", message: "New password required", icon: 'fa fa-exclamation-circle' }, { type: "danger" });
            return;
          }
          if (new_password !== confirm_password) {
            $.notify({ title: "Mismatch: ", message: "Passwords do not match", icon: 'fa fa-exclamation-circle' }, { type: "danger" });
            return;
          }

          var payload = JSON.stringify({ user_id: user_id ? parseInt(user_id) : null, new_password: new_password });

          $.ajax({
            url: 'http://localhost:5000/update-password',
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: payload
          }).done(function(resp){
            if (resp && resp.status === 'success') {
              $.notify({ title: "Success: ", message: "Password updated", icon: 'fa fa-check' }, { type: "info" });
              setTimeout(function(){ window.location.href = 'page-user-list.html'; }, 900);
            } else {
              var msg = (resp && resp.message) ? resp.message : "Failed to update password";
              $.notify({ title: "Failed: ", message: msg, icon: 'fa fa-exclamation-circle' }, { type: "danger" });
            }
          }).fail(function(){
            $.notify({ title: "Error: ", message: "Request failed", icon: 'fa fa-exclamation-circle' }, { type: "danger" });
          });
        });
      });
    </script>
  </body>
</html>